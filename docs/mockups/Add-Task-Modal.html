<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Task Modal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .phone-frame {
            width: 393px;
            height: 852px;
            background: #FFFFFF;
            border-radius: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .screen {
            width: 100%;
            flex: 1;
            overflow-y: auto;
            padding: 60px 16px 16px;
            position: relative;
        }

        /* Status Bar */
        .status-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 44px;
            background: #FFFFFF;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            font-size: 14px;
            z-index: 100;
        }

        .time { font-weight: 600; }
        .status-icons { display: flex; gap: 4px; }

        /* Modal Overlay */
        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: flex-end;
            z-index: 200;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        /* Modal Content */
        .modal-content {
            width: 100%;
            background: #FFFFFF;
            border-radius: 24px 24px 0 0;
            padding: 24px;
            max-height: 90%;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }

        /* Modal Header */
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #E0E0E0;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #212121;
        }

        .close-button {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            color: #757575;
            transition: all 0.2s;
            border-radius: 50%;
        }

        .close-button:hover {
            background: #F5F5F5;
            color: #212121;
        }

        /* Date Display */
        .date-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 24px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .date-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }

        .date-value {
            font-size: 20px;
            font-weight: 700;
            color: #FFFFFF;
        }

        /* Form Section */
        .form-section {
            margin-bottom: 24px;
        }

        .form-label {
            font-size: 14px;
            font-weight: 600;
            color: #212121;
            margin-bottom: 8px;
            display: block;
        }

        .required {
            color: #F44336;
        }

        /* Task Input */
        .task-input {
            width: 100%;
            padding: 14px 16px;
            font-size: 16px;
            border: 2px solid #E0E0E0;
            border-radius: 8px;
            outline: none;
            transition: all 0.2s;
            font-family: inherit;
        }

        .task-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .task-input::placeholder {
            color: #BDBDBD;
        }

        .char-counter {
            font-size: 12px;
            color: #757575;
            text-align: right;
            margin-top: 4px;
        }

        /* Time Picker */
        .time-picker-container {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .time-input {
            flex: 1;
            padding: 14px 16px;
            font-size: 16px;
            border: 2px solid #E0E0E0;
            border-radius: 8px;
            outline: none;
            transition: all 0.2s;
            font-family: inherit;
        }

        .time-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .time-icon {
            font-size: 24px;
        }

        .btn-add-manual {
            padding: 12px 20px;
            background: #667eea;
            color: #FFFFFF;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-add-manual:hover {
            background: #5568d3;
            transform: translateY(-1px);
        }

        .btn-add-manual:active {
            transform: translateY(0);
        }

        .btn-add-manual:disabled {
            background: #E0E0E0;
            color: #BDBDBD;
            cursor: not-allowed;
        }

        /* Task Templates */
        .templates-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .templates-label {
            font-size: 14px;
            font-weight: 600;
            color: #212121;
            display: block;
        }

        .btn-create-template {
            padding: 8px 16px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: #FFFFFF;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 6px rgba(76, 175, 80, 0.3);
        }

        .btn-create-template:hover {
            background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.4);
        }

        .btn-create-template:active {
            transform: translateY(0);
        }

        .templates-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .template-card {
            padding: 16px;
            border: 2px solid #E0E0E0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            background: #FFFFFF;
            position: relative;
        }

        .template-card:hover {
            border-color: #667eea;
            background: #F5F7FF;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .template-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #FFFFFF;
        }

        .template-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .template-name {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .template-time {
            font-size: 11px;
            opacity: 0.7;
        }

        .template-card.selected .template-name,
        .template-card.selected .template-time {
            color: #FFFFFF;
        }

        .template-card.custom {
            border-color: #4CAF50;
            background: #F1F8F4;
        }

        .template-card.custom:hover {
            border-color: #4CAF50;
            background: #E8F5E9;
        }

        .template-card.custom.selected {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        }

        .delete-template-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: #F44336;
            color: #FFFFFF;
            border: none;
            border-radius: 50%;
            font-size: 12px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .edit-template-btn {
            position: absolute;
            top: 4px;
            right: 28px;
            width: 20px;
            height: 20px;
            background: #667eea;
            color: #FFFFFF;
            border: none;
            border-radius: 50%;
            font-size: 12px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .template-card:hover .delete-template-btn,
        .template-card:hover .edit-template-btn {
            display: flex;
        }

        .delete-template-btn:hover {
            background: #D32F2F;
            transform: scale(1.1);
        }

        .edit-template-btn:hover {
            background: #5568d3;
            transform: scale(1.1);
        }

        /* Create Template Modal */
        .create-template-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .create-template-modal {
            background: #FFFFFF;
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        .template-tasks-list {
            margin: 16px 0;
        }

        .template-task-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }

        .template-task-row input[type="text"] {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #E0E0E0;
            border-radius: 6px;
            font-size: 14px;
        }

        .template-task-row input[type="time"] {
            width: 100px;
            padding: 8px 12px;
            border: 2px solid #E0E0E0;
            border-radius: 6px;
            font-size: 14px;
        }

        .btn-remove-row {
            background: #F44336;
            color: #FFFFFF;
            border: none;
            border-radius: 6px;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }

        .btn-remove-row:hover {
            background: #D32F2F;
            transform: scale(1.1);
        }

        .btn-add-task-row {
            width: 100%;
            padding: 10px;
            background: #F5F5F5;
            border: 2px dashed #BDBDBD;
            border-radius: 6px;
            color: #757575;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-add-task-row:hover {
            background: #E0E0E0;
            border-color: #9E9E9E;
            color: #212121;
        }

        /* Template Preview */
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .clear-template-btn {
            background: none;
            border: none;
            color: #667eea;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .clear-template-btn:hover {
            background: #F5F7FF;
        }

        .preview-list {
            background: #F5F7FF;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 12px;
        }

        .preview-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 6px;
            background: #FFFFFF;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preview-item:hover {
            background: #F9F9F9;
        }

        .preview-item.task-selected {
            background: #E8EBFF;
        }

        .preview-item.task-selected:hover {
            background: #DDE1FF;
        }

        .preview-item:last-child {
            margin-bottom: 0;
        }

        .preview-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #BDBDBD;
            border-radius: 4px;
            margin-right: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .preview-item.task-selected .preview-checkbox {
            background: #667eea;
            border-color: #667eea;
        }

        .preview-checkmark {
            color: #FFFFFF;
            font-size: 12px;
            display: none;
        }

        .preview-item.task-selected .preview-checkmark {
            display: block;
        }

        .preview-icon {
            margin-right: 8px;
            font-size: 16px;
        }

        .preview-task-name {
            flex: 1;
            color: #212121;
            font-weight: 500;
        }

        .preview-task-time {
            color: #757575;
            font-size: 13px;
        }

        .remove-task-btn {
            background: none;
            border: none;
            color: #F44336;
            font-size: 18px;
            cursor: pointer;
            padding: 0 4px;
            margin-left: 8px;
            transition: all 0.2s;
            opacity: 0.6;
        }

        .remove-task-btn:hover {
            opacity: 1;
            transform: scale(1.2);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 32px;
        }

        .btn {
            flex: 1;
            padding: 16px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-cancel {
            background: #F5F5F5;
            color: #757575;
        }

        .btn-cancel:hover {
            background: #E0E0E0;
            color: #212121;
        }

        .btn-save {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #FFFFFF;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .btn-save:active {
            transform: translateY(0);
        }

        .btn-save:disabled {
            background: #E0E0E0;
            color: #BDBDBD;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Helper Text */
        .helper-text {
            font-size: 12px;
            color: #757575;
            margin-top: 4px;
        }

        .select-all-btn {
            background: none;
            border: none;
            color: #667eea;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
            margin-left: 8px;
        }

        .select-all-btn:hover {
            background: #F5F7FF;
        }

        /* Scrollbar Styling */
        .modal-content::-webkit-scrollbar {
            width: 6px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: #F5F5F5;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: #BDBDBD;
            border-radius: 3px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #9E9E9E;
        }
    </style>
</head>
<body>
    <div class="phone-frame">
        <div class="status-bar">
            <span class="time">9:41</span>
            <div class="status-icons">
                <span>üì∂</span>
                <span>üì°</span>
                <span>üîã</span>
            </div>
        </div>

        <div class="screen">
            <!-- Modal Overlay -->
            <div class="modal-overlay" onclick="closeModalOnBackdrop(event)">
                <div class="modal-content" onclick="event.stopPropagation()">
                    <!-- Modal Header -->
                    <div class="modal-header">
                        <h2 class="modal-title">Add New Task</h2>
                        <div class="close-button" onclick="closeModal()">√ó</div>
                    </div>

                    <!-- Date Display -->
                    <div class="date-display">
                        <div class="date-label">Adding task for</div>
                        <div class="date-value" id="taskDate">01.02.2026</div>
                    </div>

                    <!-- Task Description -->
                    <div class="form-section">
                        <label class="form-label">
                            Manual Task Entry
                        </label>
                        <input 
                            type="text" 
                            class="task-input" 
                            id="taskDescription"
                            placeholder="What do you need to do?"
                            maxlength="100"
                            oninput="updateCharCounter();"
                        >
                        <div class="char-counter">
                            <span id="charCount">0</span>/100
                        </div>
                    </div>

                    <!-- Time Picker -->
                    <div class="form-section">
                        <label class="form-label">
                            Task Time
                        </label>
                        <div class="time-picker-container">
                            <span class="time-icon">üïê</span>
                            <input 
                                type="time" 
                                class="time-input" 
                                id="taskTime"
                                value="08:00"
                            >
                            <button class="btn-add-manual" onclick="addManualTask()">
                                + Add
                            </button>
                        </div>
                        <div class="helper-text">Add individual tasks one at a time</div>
                    </div>

                    <!-- Manual Tasks Preview -->
                    <div class="form-section" id="manualTasksPreview" style="display: none;">
                        <div class="preview-header">
                            <label class="templates-label">Manual tasks to add:</label>
                            <button class="clear-template-btn" onclick="clearManualTasks()">Clear All</button>
                        </div>
                        <div class="preview-list" id="manualTasksList"></div>
                    </div>

                    <!-- Task Templates -->
                    <div class="form-section">
                        <div class="templates-header">
                            <label class="templates-label">
                                Or Choose from Templates (Optional)
                            </label>
                            <button class="btn-create-template" onclick="openCreateTemplateModal()">
                                <span style="font-size: 16px; margin-right: 4px;">+</span> Create Template
                            </button>
                        </div>
                        <div class="templates-grid" id="templatesGrid">
                            <div class="template-card" onclick="selectTemplate(this, 'daily')">
                                <div class="template-icon">‚òÄÔ∏è</div>
                                <div class="template-name">Daily Routine</div>
                                <div class="template-time">3 tasks</div>
                            </div>
                            
                            <div class="template-card" onclick="selectTemplate(this, 'work')">
                                <div class="template-icon">üíº</div>
                                <div class="template-name">Work Day</div>
                                <div class="template-time">4 tasks</div>
                            </div>
                            
                            <div class="template-card" onclick="selectTemplate(this, 'fitness')">
                                <div class="template-icon">üèÉ</div>
                                <div class="template-name">Fitness</div>
                                <div class="template-time">3 tasks</div>
                            </div>
                            
                            <div class="template-card" onclick="selectTemplate(this, 'selfcare')">
                                <div class="template-icon">üßò</div>
                                <div class="template-name">Self Care</div>
                                <div class="template-time">3 tasks</div>
                            </div>
                            
                            <div class="template-card" onclick="selectTemplate(this, 'study')">
                                <div class="template-icon">üìö</div>
                                <div class="template-name">Study Session</div>
                                <div class="template-time">4 tasks</div>
                            </div>
                            
                            <div class="template-card" onclick="selectTemplate(this, 'evening')">
                                <div class="template-icon">üåô</div>
                                <div class="template-name">Evening Wind-down</div>
                                <div class="template-time">3 tasks</div>
                            </div>
                        </div>
                        <div class="helper-text">Click to select/deselect templates. You can select multiple templates.</div>
                    </div>

                    <!-- Create Template Modal -->
                    <div class="create-template-overlay" id="createTemplateOverlay" onclick="closeCreateTemplateModal(event)">
                        <div class="create-template-modal" onclick="event.stopPropagation()">
                            <div class="modal-header">
                                <h3 class="modal-title" id="templateModalTitle" style="font-size: 20px;">Create Custom Template</h3>
                                <div class="close-button" onclick="closeCreateTemplateModal()">√ó</div>
                            </div>

                            <div class="form-section">
                                <label class="form-label">Template Name</label>
                                <input 
                                    type="text" 
                                    class="task-input" 
                                    id="newTemplateName"
                                    placeholder="e.g., My Morning Routine"
                                    maxlength="30"
                                >
                            </div>

                            <div class="form-section">
                                <label class="form-label">Template Icon (emoji)</label>
                                <input 
                                    type="text" 
                                    class="task-input" 
                                    id="newTemplateIcon"
                                    placeholder="e.g., ‚òÄÔ∏è"
                                    maxlength="2"
                                >
                            </div>

                            <div class="form-section">
                                <label class="form-label">Tasks</label>
                                <div class="template-tasks-list" id="templateTasksList">
                                    <!-- Tasks will be added here -->
                                </div>
                                <button class="btn-add-task-row" onclick="addTemplateTaskRow()">
                                    + Add Task
                                </button>
                            </div>

                            <div class="action-buttons" style="margin-top: 24px;">
                                <button class="btn btn-cancel" onclick="closeCreateTemplateModal()">Cancel</button>
                                <button class="btn btn-save" id="saveTemplateButton" onclick="saveCustomTemplate()">
                                    Save Template
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Selected Template Preview -->
                    <div class="form-section" id="templatePreview" style="display: none;">
                        <div class="preview-header">
                            <label class="templates-label">Tasks to add:</label>
                            <div>
                                <button class="select-all-btn" onclick="selectAllTasks()">Select All</button>
                                <button class="clear-template-btn" onclick="clearAllTasks()">Clear All</button>
                            </div>
                        </div>
                        <div class="helper-text" style="margin-bottom: 12px;">Click on template tasks to select/deselect individual items</div>
                        <div class="preview-list" id="previewList"></div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <button class="btn btn-cancel" onclick="closeModal()">Cancel</button>
                        <button class="btn btn-save" id="saveButton" onclick="saveTasks()" disabled>
                            <span id="saveButtonText">Add Task</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Template definitions with multiple tasks
        const templates = {
            daily: [
                { description: 'Morning Run', time: '06:00', icon: 'üèÉ' },
                { description: 'Drink Water (2L)', time: '08:00', icon: 'üíß' },
                { description: 'Break - Mid Work', time: '14:30', icon: '‚òï' }
            ],
            work: [
                { description: 'Check Emails', time: '09:00', icon: 'üìß' },
                { description: 'Team Meeting', time: '10:00', icon: 'üë•' },
                { description: 'Project Work', time: '11:00', icon: 'üíº' },
                { description: 'Review Tasks', time: '16:00', icon: 'üìã' }
            ],
            fitness: [
                { description: 'Morning Workout', time: '06:30', icon: 'üèãÔ∏è' },
                { description: 'Protein Shake', time: '07:30', icon: 'ü•§' },
                { description: 'Evening Stretch', time: '18:00', icon: 'ü§∏' }
            ],
            selfcare: [
                { description: 'Meditation', time: '07:00', icon: 'üßò' },
                { description: 'Journal Writing', time: '20:00', icon: 'üìù' },
                { description: 'Read Book', time: '21:00', icon: 'üìñ' }
            ],
            study: [
                { description: 'Review Notes', time: '09:00', icon: 'üìö' },
                { description: 'Practice Problems', time: '10:30', icon: '‚úçÔ∏è' },
                { description: 'Study Break', time: '12:00', icon: '‚òï' },
                { description: 'Deep Study Session', time: '14:00', icon: 'üéØ' }
            ],
            evening: [
                { description: 'Dinner Preparation', time: '18:00', icon: 'üçΩÔ∏è' },
                { description: 'Evening Walk', time: '19:30', icon: 'üö∂' },
                { description: 'Night Routine', time: '21:30', icon: 'üåô' }
            ]
        };

        let selectedTemplates = new Set();
        let selectedTasks = new Map(); // Map of template:task combinations
        let manualTasks = []; // Array of manually added tasks
        let customTemplates = {}; // Store custom templates
        let templateTaskRowCounter = 0;
        let editingTemplateKey = null; // Track which template is being edited

        // Get current date from parent or use default
        function getTaskDate() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('date') || '01.02.2026';
        }

        // Set date on load
        window.addEventListener('load', function() {
            document.getElementById('taskDate').textContent = getTaskDate();
            renderTemplateCards();
        });

        // Update character counter
        function updateCharCounter() {
            const input = document.getElementById('taskDescription');
            const counter = document.getElementById('charCount');
            counter.textContent = input.value.length;
        }

        // Validate form
        function validateForm() {
            const saveButton = document.getElementById('saveButton');
            
            // Count selected tasks from templates
            let selectedTaskCount = 0;
            selectedTasks.forEach(tasks => selectedTaskCount += tasks.size);
            
            // Enable if at least one task is selected OR manual tasks exist
            if (selectedTaskCount > 0 || manualTasks.length > 0) {
                saveButton.disabled = false;
            } else {
                saveButton.disabled = true;
            }
        }

        // Select template
        function selectTemplate(card, templateKey) {
            // Toggle selection
            if (selectedTemplates.has(templateKey)) {
                // Deselect
                selectedTemplates.delete(templateKey);
                selectedTasks.delete(templateKey);
                card.classList.remove('selected');
            } else {
                // Select
                selectedTemplates.add(templateKey);
                
                // Auto-select all tasks from this template
                const taskSet = new Set();
                templates[templateKey].forEach((task, index) => {
                    taskSet.add(index);
                });
                selectedTasks.set(templateKey, taskSet);
                
                card.classList.add('selected');
            }
            
            // Update preview and button
            updateCombinedPreview();
            updateSaveButton();
            validateForm();
        }

        // Add manual task
        function addManualTask() {
            const description = document.getElementById('taskDescription').value.trim();
            const time = document.getElementById('taskTime').value;
            
            if (!description || !time) {
                alert('Please enter both task description and time');
                return;
            }
            
            // Add to manual tasks array
            manualTasks.push({
                description: description,
                time: time,
                icon: 'üìù'
            });
            
            // Clear inputs
            document.getElementById('taskDescription').value = '';
            document.getElementById('taskTime').value = '08:00';
            updateCharCounter();
            
            // Update preview
            updateManualTasksPreview();
            updateSaveButton();
            validateForm();
        }

        // Update manual tasks preview
        function updateManualTasksPreview() {
            // Manual tasks now shown in combined preview
            updateCombinedPreview();
        }

        // Update combined preview (manual + template tasks)
        function updateCombinedPreview() {
            const previewSection = document.getElementById('templatePreview');
            const previewList = document.getElementById('previewList');
            
            // Clear previous preview
            previewList.innerHTML = '';
            
            // Check if we have any tasks
            const hasManualTasks = manualTasks.length > 0;
            const hasTemplateTasks = selectedTemplates.size > 0;
            
            if (!hasManualTasks && !hasTemplateTasks) {
                previewSection.style.display = 'none';
                return;
            }
            
            // Add manual tasks section
            if (hasManualTasks) {
                const manualHeader = document.createElement('div');
                manualHeader.style.cssText = 'font-weight: 600; color: #667eea; margin-bottom: 8px; font-size: 12px; text-transform: uppercase; display: flex; justify-content: space-between; align-items: center;';
                manualHeader.innerHTML = `
                    <span>Manual Tasks</span>
                    <button class="clear-template-btn" onclick="clearManualTasks()" style="font-size: 11px; padding: 2px 6px;">Clear Manual</button>
                `;
                previewList.appendChild(manualHeader);
                
                manualTasks.forEach((task, index) => {
                    const taskItem = document.createElement('div');
                    taskItem.className = 'preview-item task-selected';
                    taskItem.innerHTML = `
                        <div class="preview-checkbox">
                            <span class="preview-checkmark">‚úì</span>
                        </div>
                        <span class="preview-icon">${task.icon}</span>
                        <span class="preview-task-name">${task.description}</span>
                        <span class="preview-task-time">${task.time}</span>
                        <button class="remove-task-btn" onclick="removeManualTask(${index})">√ó</button>
                    `;
                    previewList.appendChild(taskItem);
                });
            }
            
            // Add template tasks section
            if (hasTemplateTasks) {
                selectedTemplates.forEach(templateKey => {
                    const tasks = templates[templateKey];
                    const templateInfo = getTemplateInfo(templateKey);
                    const taskSet = selectedTasks.get(templateKey) || new Set();
                    
                    // Add template header
                    const templateHeader = document.createElement('div');
                    templateHeader.style.cssText = 'font-weight: 600; color: #667eea; margin-top: ' + (hasManualTasks || previewList.children.length > 0 ? '16px' : '0') + '; margin-bottom: 8px; font-size: 12px; text-transform: uppercase;';
                    templateHeader.textContent = templateInfo.name;
                    previewList.appendChild(templateHeader);
                    
                    // Add tasks
                    tasks.forEach((task, index) => {
                        const isSelected = taskSet.has(index);
                        const previewItem = document.createElement('div');
                        previewItem.className = 'preview-item' + (isSelected ? ' task-selected' : '');
                        previewItem.onclick = () => toggleTask(templateKey, index, previewItem);
                        previewItem.innerHTML = `
                            <div class="preview-checkbox">
                                <span class="preview-checkmark">‚úì</span>
                            </div>
                            <span class="preview-icon">${task.icon}</span>
                            <span class="preview-task-name">${task.description}</span>
                            <span class="preview-task-time">${task.time}</span>
                        `;
                        previewList.appendChild(previewItem);
                    });
                });
            }
            
            // Show preview section
            previewSection.style.display = 'block';
        }

        // Remove manual task
        function removeManualTask(index) {
            manualTasks.splice(index, 1);
            updateCombinedPreview();
            updateSaveButton();
            validateForm();
        }

        // Clear all manual tasks
        function clearManualTasks() {
            manualTasks = [];
            updateCombinedPreview();
            updateSaveButton();
            validateForm();
        }

        // Toggle individual task selection
        function toggleTask(templateKey, taskIndex, element) {
            if (!selectedTasks.has(templateKey)) {
                selectedTasks.set(templateKey, new Set());
            }
            
            const taskSet = selectedTasks.get(templateKey);
            
            if (taskSet.has(taskIndex)) {
                taskSet.delete(taskIndex);
                element.classList.remove('task-selected');
            } else {
                taskSet.add(taskIndex);
                element.classList.add('task-selected');
            }
            
            // If no tasks selected from this template, remove template selection
            if (taskSet.size === 0) {
                selectedTemplates.delete(templateKey);
                selectedTasks.delete(templateKey);
                // Remove visual selection from template card
                document.querySelectorAll('.template-card').forEach(card => {
                    if (card.onclick.toString().includes(`'${templateKey}'`)) {
                        card.classList.remove('selected');
                    }
                });
            }
            
            updateCombinedPreview();
            updateSaveButton();
            validateForm();
        }

        // Select all tasks
        function selectAllTasks() {
            selectedTemplates.forEach(templateKey => {
                const taskSet = new Set();
                templates[templateKey].forEach((task, index) => {
                    taskSet.add(index);
                });
                selectedTasks.set(templateKey, taskSet);
            });
            
            updateCombinedPreview();
            updateSaveButton();
            validateForm();
        }

        // Update template preview (now calls combined)
        function updateTemplatePreview() {
            updateCombinedPreview();
        }
        
        // Get template info
        function getTemplateInfo(templateKey) {
            const templateNames = {
                daily: 'Daily Routine',
                work: 'Work Day',
                fitness: 'Fitness',
                selfcare: 'Self Care',
                study: 'Study Session',
                evening: 'Evening Wind-down'
            };
            
            // Check if it's a custom template
            if (customTemplates[templateKey]) {
                return { name: customTemplates[templateKey].name };
            }
            
            return { name: templateNames[templateKey] || templateKey };
        }

        // Render template cards
        function renderTemplateCards() {
            const grid = document.getElementById('templatesGrid');
            grid.innerHTML = '';
            
            // Add default templates
            const defaultTemplates = [
                { key: 'daily', icon: '‚òÄÔ∏è', name: 'Daily Routine', count: 3 },
                { key: 'work', icon: 'üíº', name: 'Work Day', count: 4 },
                { key: 'fitness', icon: 'üèÉ', name: 'Fitness', count: 3 },
                { key: 'selfcare', icon: 'üßò', name: 'Self Care', count: 3 },
                { key: 'study', icon: 'üìö', name: 'Study Session', count: 4 },
                { key: 'evening', icon: 'üåô', name: 'Evening Wind-down', count: 3 }
            ];
            
            defaultTemplates.forEach(t => {
                const card = createTemplateCard(t.key, t.icon, t.name, t.count, false);
                grid.appendChild(card);
            });
            
            // Add custom templates
            Object.keys(customTemplates).forEach(key => {
                const t = customTemplates[key];
                const card = createTemplateCard(key, t.icon, t.name, t.tasks.length, true);
                grid.appendChild(card);
            });
        }

        // Create template card element
        function createTemplateCard(key, icon, name, count, isCustom) {
            const card = document.createElement('div');
            card.className = 'template-card' + (isCustom ? ' custom' : '');
            card.onclick = function() { selectTemplate(this, key); };
            
            card.innerHTML = `
                <button class="edit-template-btn" onclick="event.stopPropagation(); editTemplate('${key}')">‚úé</button>
                <button class="delete-template-btn" onclick="event.stopPropagation(); deleteTemplate('${key}')">√ó</button>
                <div class="template-icon">${icon}</div>
                <div class="template-name">${name}</div>
                <div class="template-time">${count} tasks</div>
            `;
            
            return card;
        }

        // Open create template modal
        function openCreateTemplateModal() {
            editingTemplateKey = null; // Not editing, creating new
            document.getElementById('templateModalTitle').textContent = 'Create Custom Template';
            document.getElementById('saveTemplateButton').textContent = 'Save Template';
            document.getElementById('createTemplateOverlay').style.display = 'flex';
            document.getElementById('newTemplateName').value = '';
            document.getElementById('newTemplateIcon').value = '‚≠ê';
            document.getElementById('templateTasksList').innerHTML = '';
            templateTaskRowCounter = 0;
            
            // Add 3 default rows
            addTemplateTaskRow();
            addTemplateTaskRow();
            addTemplateTaskRow();
        }

        // Open edit template modal
        function editTemplate(key) {
            editingTemplateKey = key; // Set editing mode
            
            // Check if it's a custom or default template
            let template;
            if (customTemplates[key]) {
                template = customTemplates[key];
            } else {
                // It's a default template, get from templates object
                template = {
                    name: getTemplateInfo(key).name,
                    icon: getTemplateIcon(key),
                    tasks: templates[key]
                };
            }
            
            document.getElementById('templateModalTitle').textContent = 'Edit Template';
            document.getElementById('saveTemplateButton').textContent = 'Update Template';
            document.getElementById('createTemplateOverlay').style.display = 'flex';
            document.getElementById('newTemplateName').value = template.name;
            document.getElementById('newTemplateIcon').value = template.icon;
            document.getElementById('templateTasksList').innerHTML = '';
            templateTaskRowCounter = 0;
            
            // Populate existing tasks
            template.tasks.forEach(task => {
                addTemplateTaskRow(task.description, task.time);
            });
        }

        // Get template icon
        function getTemplateIcon(key) {
            const icons = {
                daily: '‚òÄÔ∏è',
                work: 'üíº',
                fitness: 'üèÉ',
                selfcare: 'üßò',
                study: 'üìö',
                evening: 'üåô'
            };
            return icons[key] || '‚≠ê';
        }

        // Close create template modal
        function closeCreateTemplateModal(event) {
            if (event && event.target !== event.currentTarget) return;
            editingTemplateKey = null; // Clear editing mode
            document.getElementById('createTemplateOverlay').style.display = 'none';
        }

        // Add template task row
        function addTemplateTaskRow(description = '', time = '08:00') {
            const list = document.getElementById('templateTasksList');
            const rowId = `task-row-${templateTaskRowCounter++}`;
            
            const row = document.createElement('div');
            row.className = 'template-task-row';
            row.id = rowId;
            row.innerHTML = `
                <input type="text" placeholder="Task description" class="task-desc" value="${description}" />
                <input type="time" value="${time}" class="task-time" />
                <button class="btn-remove-row" onclick="removeTemplateTaskRow('${rowId}')">√ó</button>
            `;
            
            list.appendChild(row);
        }

        // Remove template task row
        function removeTemplateTaskRow(rowId) {
            document.getElementById(rowId)?.remove();
        }

        // Save custom template
        function saveCustomTemplate() {
            const name = document.getElementById('newTemplateName').value.trim();
            const icon = document.getElementById('newTemplateIcon').value.trim() || '‚≠ê';
            
            if (!name) {
                alert('Please enter a template name');
                return;
            }
            
            // Collect tasks
            const taskRows = document.querySelectorAll('.template-task-row');
            const tasks = [];
            
            taskRows.forEach(row => {
                const desc = row.querySelector('.task-desc').value.trim();
                const time = row.querySelector('.task-time').value;
                
                if (desc && time) {
                    tasks.push({
                        description: desc,
                        time: time,
                        icon: 'üìå'
                    });
                }
            });
            
            if (tasks.length === 0) {
                alert('Please add at least one task');
                return;
            }
            
            // Determine if creating new or editing existing
            let key;
            const defaultTemplates = ['daily', 'work', 'fitness', 'selfcare', 'study', 'evening'];
            
            if (editingTemplateKey) {
                // Check if editing a default template
                if (defaultTemplates.includes(editingTemplateKey)) {
                    // Editing default template - update in place
                    key = editingTemplateKey;
                } else {
                    // Editing custom template
                    key = editingTemplateKey;
                }
                
                // If template was selected, update its tasks in selectedTasks
                if (selectedTemplates.has(key)) {
                    // Re-select all tasks from updated template
                    const taskSet = new Set();
                    tasks.forEach((task, index) => {
                        taskSet.add(index);
                    });
                    selectedTasks.set(key, taskSet);
                }
            } else {
                // Creating new template
                key = 'custom_' + Date.now();
            }
            
            // Save to appropriate place
            if (!defaultTemplates.includes(key)) {
                // Save custom templates
                customTemplates[key] = {
                    name: name,
                    icon: icon,
                    tasks: tasks
                };
            }
            
            // Always update main templates object
            templates[key] = tasks;
            
            // Re-render template cards
            renderTemplateCards();
            
            // Update preview if template was selected
            if (selectedTemplates.has(key)) {
                updateCombinedPreview();
                updateSaveButton();
                validateForm();
            }
            
            // Close modal
            closeCreateTemplateModal();
            
            // Show success message
            if (editingTemplateKey) {
                alert(`Template "${name}" updated successfully!`);
            } else {
                alert(`Template "${name}" created successfully!`);
            }
        }

        // Delete template
        function deleteTemplate(key) {
            // Check if it's a default template
            const defaultTemplates = ['daily', 'work', 'fitness', 'selfcare', 'study', 'evening'];
            
            if (defaultTemplates.includes(key)) {
                alert('Default templates cannot be deleted. You can only edit them.');
                return;
            }
            
            // It's a custom template, proceed with deletion
            if (confirm('Are you sure you want to delete this template?')) {
                delete customTemplates[key];
                delete templates[key];
                
                // Deselect if selected
                if (selectedTemplates.has(key)) {
                    selectedTemplates.delete(key);
                    selectedTasks.delete(key);
                }
                
                renderTemplateCards();
                updateCombinedPreview();
                updateSaveButton();
                validateForm();
            }
        }
        
        // Update save button text
        function updateSaveButton() {
            const saveButton = document.getElementById('saveButtonText');
            
            // Count selected tasks from templates
            let templateTaskCount = 0;
            selectedTasks.forEach(taskSet => {
                templateTaskCount += taskSet.size;
            });
            
            // Total tasks = template tasks + manual tasks
            const totalTasks = templateTaskCount + manualTasks.length;
            
            if (totalTasks === 0) {
                saveButton.textContent = 'Add Task';
            } else if (totalTasks === 1) {
                saveButton.textContent = 'Add 1 Task';
            } else {
                saveButton.textContent = `Add ${totalTasks} Tasks`;
            }
        }

        // Clear template selection
        function clearTemplate() {
            selectedTemplates.clear();
            selectedTasks.clear();
            
            // Remove selected class from all cards
            document.querySelectorAll('.template-card').forEach(c => {
                c.classList.remove('selected');
            });
            
            updateCombinedPreview();
            updateSaveButton();
            validateForm();
        }

        // Clear all tasks (manual + template)
        function clearAllTasks() {
            // Clear templates
            selectedTemplates.clear();
            selectedTasks.clear();
            
            // Remove selected class from all cards
            document.querySelectorAll('.template-card').forEach(c => {
                c.classList.remove('selected');
            });
            
            // Clear manual tasks
            manualTasks = [];
            
            updateCombinedPreview();
            updateSaveButton();
            validateForm();
        }

        // Save tasks
        function saveTasks() {
            const date = document.getElementById('taskDate').textContent;
            let tasksToSave = [];
            
            // Add manual tasks
            manualTasks.forEach(task => {
                tasksToSave.push({
                    description: task.description,
                    time: task.time,
                    date: date,
                    isCompleted: false
                });
            });
            
            // Add selected tasks from templates
            if (selectedTasks.size > 0) {
                selectedTasks.forEach((taskSet, templateKey) => {
                    const templateTasks = templates[templateKey];
                    taskSet.forEach(taskIndex => {
                        const task = templateTasks[taskIndex];
                        tasksToSave.push({
                            description: task.description,
                            time: task.time,
                            date: date,
                            isCompleted: false
                        });
                    });
                });
            }
            
            // Sort by time
            tasksToSave.sort((a, b) => a.time.localeCompare(b.time));
            
            // In a real app, this would save to database/storage
            console.log('Saving tasks:', tasksToSave);
            
            if (tasksToSave.length === 1) {
                alert(`Task "${tasksToSave[0].description}" scheduled for ${tasksToSave[0].time} on ${date}`);
            } else {
                const message = `${tasksToSave.length} tasks added for ${date}:\n\n` + 
                      tasksToSave.map(t => `‚Ä¢ ${t.description} at ${t.time}`).join('\n');
                alert(message);
            }
            
            // Close modal and return to tasks screen
            closeModal();
        }

        // Close modal
        function closeModal() {
            // In a real app, this would navigate back or hide the modal
            window.history.back();
        }

        // Close modal when clicking on backdrop
        function closeModalOnBackdrop(event) {
            if (event.target === event.currentTarget) {
                closeModal();
            }
        }

        // Handle keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            } else if (event.key === 'Enter' && event.ctrlKey) {
                if (!document.getElementById('saveButton').disabled) {
                    saveTasks();
                }
            }
        });
    </script>
</body>
</html>
